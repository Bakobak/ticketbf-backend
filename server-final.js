const express = require('express');
const cors = require('cors');
const bcrypt = require('bcryptjs');
const jwt = require('jsonwebtoken');

const app = express();
const PORT = process.env.PORT || 3000;
const JWT_SECRET = process.env.JWT_SECRET || 'ticketbf-secret-2025';

// Configuration CORS TR√àS PERMISSIVE pour debug
app.use(cors({
    origin: '*',
    credentials: true,
    methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
    allowedHeaders: ['*']
}));

// Middleware pour g√©rer les requ√™tes OPTIONS (preflight)
app.options('*', (req, res) => {
    res.header('Access-Control-Allow-Origin', '*');
    res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
    res.header('Access-Control-Allow-Headers', 'Origin, X-Requested-With, Content-Type, Accept, Authorization');
    res.sendStatus(200);
});

app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true, limit: '10mb' }));

// Middleware de logging pour debug
app.use((req, res, next) => {
    console.log(`${new Date().toISOString()} - ${req.method} ${req.path}`);
    console.log('Body:', req.body);
    next();
});

// Base de donn√©es en m√©moire simple
let users = [
    {
        id: '1',
        firstName: 'Admin',
        lastName: 'Test',
        email: 'admin@ticketbf.com',
        password: 'password123',
        phone: '+226 XX XX XX XX',
        city: 'Ouagadougou',
        role: 'admin',
        isVerified: true,
        createdAt: new Date().toISOString()
    }
];

let events = [
    {
        id: '1',
        name: 'Concert de Floby',
        description: 'Le roi de la musique burkinab√® en concert',
        date: '2025-07-15T20:00:00',
        location: 'Palais des Sports de Ouaga',
        price: 5000,
        category: 'concert',
        createdBy: '1',
        createdAt: new Date().toISOString()
    },
    {
        id: '2',
        name: 'Match √âtoile Filante vs ASFA',
        description: 'Derby de Ouagadougou',
        date: '2025-07-12T16:00:00',
        location: 'Stade du 4-Ao√ªt',
        price: 1000,
        category: 'sport',
        createdBy: '1',
        createdAt: new Date().toISOString()
    }
];

// ROUTE 1: PAGE D'ACCUEIL
app.get('/', (req, res) => {
    console.log('GET / appel√©');
    res.json({
        message: "üéüÔ∏è TicketBF - Plateforme de billetterie du Burkina Faso",
        version: "2.1.0",
        status: "Actif - API Corrig√©e",
        timestamp: new Date().toISOString(),
        users_count: users.length,
        events_count: events.length,
        routes: [
            "GET / - Cette page",
            "GET /api/health - Test API",
            "GET /api/cities - Villes BF",
            "POST /api/auth/register - Inscription",
            "POST /api/auth/login - Connexion",
            "GET /api/events - √âv√©nements"
        ]
    });
});

// ROUTE 2: SANT√â API
app.get('/api/health', (req, res) => {
    console.log('GET /api/health appel√©');
    res.json({
        status: 'OK',
        message: 'API TicketBF fonctionne correctement',
        timestamp: new Date().toISOString(),
        uptime: process.uptime(),
        data: {
            users: users.length,
            events: events.length
        }
    });
});

// ROUTE 3: VILLES
app.get('/api/cities', (req, res) => {
    console.log('GET /api/cities appel√©');
    const cities = [
        'Ouagadougou', 'Bobo-Dioulasso', 'Koudougou', 'Ouahigouya',
        'Banfora', 'Tenkodogo', 'Kaya', 'Fada N\'Gourma'
    ];
    
    res.json({
        success: true,
        data: { cities: cities },
        count: cities.length
    });
});

// ROUTE 4: INSCRIPTION AM√âLIOR√âE
app.post('/api/auth/register', async (req, res) => {
    try {
        console.log('POST /api/auth/register appel√© avec:', req.body);
        
        const { 
            firstName, 
            lastName, 
            email, 
            phone, 
            city, 
            password, 
            role, 
            companyName, 
            businessType 
        } = req.body;

        // Validation des champs obligatoires
        if (!firstName || !lastName || !email || !phone || !city || !password) {
            console.log('Validation √©chou√©e - champs manquants');
            return res.status(400).json({
                success: false,
                message: 'Tous les champs obligatoires doivent √™tre remplis'
            });
        }

        // Validation du mot de passe
        if (password.length < 6) {
            return res.status(400).json({
                success: false,
                message: 'Le mot de passe doit contenir au moins 6 caract√®res'
            });
        }

        // Validation email
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            return res.status(400).json({
                success: false,
                message: 'Veuillez entrer un email valide'
            });
        }

        // V√©rifier email unique
        const existingUser = users.find(u => u.email.toLowerCase() === email.toLowerCase());
        if (existingUser) {
            console.log('Email d√©j√† utilis√©:', email);
            return res.status(400).json({
                success: false,
                message: 'Un utilisateur avec cet email existe d√©j√†'
            });
        }

        // Validation sp√©cifique aux promoteurs
        if (role === 'promoter' && (!companyName || !businessType)) {
            return res.status(400).json({
                success: false,
                message: 'Les informations d\'entreprise sont requises pour les promoteurs'
            });
        }

        // Cr√©er utilisateur
        const newUser = {
            id: (users.length + 1).toString(),
            firstName: firstName.trim(),
            lastName: lastName.trim(),
            email: email.toLowerCase().trim(),
            phone: phone.trim(),
            city: city.trim(),
            password: password, // En production, hasher le mot de passe
            role: role || 'user',
            companyName: companyName || null,
            businessType: businessType || null,
            isVerified: true, // Auto-v√©rifi√© pour debug
            createdAt: new Date().toISOString()
        };

        users.push(newUser);
        console.log('Utilisateur cr√©√©:', { id: newUser.id, email: newUser.email, role: newUser.role });

        // G√©n√©rer token
        const token = jwt.sign(
            { 
                userId: newUser.id, 
                email: newUser.email, 
                role: newUser.role 
            },
            JWT_SECRET,
            { expiresIn: '7d' }
        );

        res.status(201).json({
            success: true,
            message: `Bienvenue sur TicketBF, ${firstName} ! Votre compte a √©t√© cr√©√© avec succ√®s.`,
            data: {
                user: {
                    id: newUser.id,
                    firstName: newUser.firstName,
                    lastName: newUser.lastName,
                    email: newUser.email,
                    phone: newUser.phone,
                    city: newUser.city,
                    role: newUser.role,
                    companyName: newUser.companyName,
                    businessType: newUser.businessType,
                    isVerified: newUser.isVerified
                },
                token: token
            }
        });

    } catch (error) {
        console.error('Erreur inscription:', error);
        res.status(500).json({
            success: false,
            message: 'Erreur lors de l\'inscription',
            error: error.message
        });
    }
});

// ROUTE 5: CONNEXION AM√âLIOR√âE
app.post('/api/auth/login', async (req, res) => {
    try {
        console.log('POST /api/auth/login appel√© avec:', req.body);
        
        const { email, password } = req.body;

        if (!email || !password) {
            return res.status(400).json({
                success: false,
                message: 'Email et mot de passe requis'
            });
        }

        // Trouver utilisateur
        const user = users.find(u => u.email.toLowerCase() === email.toLowerCase());
        if (!user) {
            return res.status(401).json({
                success: false,
                message: 'Email ou mot de passe incorrect'
            });
        }

        // V√©rifier mot de passe (simple pour debug)
        if (user.password !== password) {
            return res.status(401).json({
                success: false,
                message: 'Email ou mot de passe incorrect'
            });
        }

        // G√©n√©rer token
        const token = jwt.sign(
            { 
                userId: user.id, 
                email: user.email, 
                role: user.role 
            },
            JWT_SECRET,
            { expiresIn: '7d' }
        );

        res.json({
            success: true,
            message: `Bienvenue de retour, ${user.firstName} !`,
            data: {
                user: {
                    id: user.id,
                    firstName: user.firstName,
                    lastName: user.lastName,
                    email: user.email,
                    phone: user.phone,
                    city: user.city,
                    role: user.role,
                    companyName: user.companyName,
                    businessType: user.businessType,
                    isVerified: user.isVerified
                },
                token: token
            }
        });

    } catch (error) {
        console.error('Erreur connexion:', error);
        res.status(500).json({
            success: false,
            message: 'Erreur lors de la connexion',
            error: error.message
        });
    }
});

// ROUTE 6: √âV√âNEMENTS
app.get('/api/events', (req, res) => {
    console.log('GET /api/events appel√©');
    res.json({
        success: true,
        data: events,
        total: events.length
    });
});

// ROUTE 7: LISTE UTILISATEURS (DEBUG)
app.get('/api/users', (req, res) => {
    console.log('GET /api/users appel√©');
    res.json({
        success: true,
        data: users.map(u => ({
            id: u.id,
            firstName: u.firstName,
            lastName: u.lastName,
            email: u.email,
            role: u.role,
            city: u.city,
            isVerified: u.isVerified,
            createdAt: u.createdAt
        })),
        total: users.length
    });
});

// Middleware de gestion d'erreurs
app.use((error, req, res, next) => {
    console.error('Erreur non g√©r√©e:', error);
    res.status(500).json({
        success: false,
        message: 'Erreur interne du serveur',
        error: error.message
    });
});

// Route 404
app.use('*', (req, res) => {
    console.log('Route non trouv√©e:', req.method, req.path);
    res.status(404).json({
        success: false,
        message: `Route ${req.method} ${req.path} non trouv√©e`,
        available_routes: [
            'GET /',
            'GET /api/health',
            'GET /api/cities',
            'POST /api/auth/register',
            'POST /api/auth/login',
            'GET /api/events',
            'GET /api/users'
        ]
    });
});

// D√©marrage serveur
app.listen(PORT, () => {
    console.log(`üöÄ TicketBF Backend d√©marr√© sur port ${PORT}`);
    console.log(`üì± Frontend: https://main.difewvnbygxxx.amplifyapp.com`);
    console.log(`üîß Mode DEBUG activ√© - Routes /api/ corrig√©es`);
    console.log(`üë• Utilisateurs: ${users.length}`);
    console.log(`üé™ √âv√©nements: ${events.length}`);
    console.log(`üìß Test login: admin@ticketbf.com / password123`);
    console.log(`üìã Routes disponibles:`);
    console.log(`   GET /api/health`);
    console.log(`   GET /api/cities`);
    console.log(`   POST /api/auth/register`);
    console.log(`   POST /api/auth/login`);
    console.log(`   GET /api/events`);
});

module.exports = app;
